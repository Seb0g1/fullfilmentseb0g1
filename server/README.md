# Chat Server для интеграции с Telegram

Backend сервер для обработки сообщений чата и интеграции с Telegram ботом.

## Установка

```bash
cd server
npm install
```

## Настройка

1. Скопируйте `.env.example` в `.env`:
```bash
cp .env.example .env
```

2. Заполните переменные окружения:
- `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота (получить у @BotFather)
- `TELEGRAM_GROUP_CHAT_ID` - ID группы в Telegram, куда будут приходить сообщения
- `TELEGRAM_TOPIC_CHAT_CLIENT` - ID топика "Чат с клиентом" (опционально, если группа с топиками)
- `TELEGRAM_TOPIC_CALCULATOR` - ID топика "Калькулятор заявки" (опционально)
- `TELEGRAM_TOPIC_CONTACT_FORM` - ID топика "Оставить заявку" (опционально)
- `PORT` - порт сервера (по умолчанию 3001)

## Получение Group Chat ID

1. Добавьте бота в группу
2. Сделайте бота администратором (опционально)
3. Отправьте сообщение в группу
4. Перейдите по ссылке в браузере:
```
https://api.telegram.org/bot<ВАШ_ТОКЕН>/getUpdates
```
5. Найдите в ответе `"chat":{"id":-123456789}` - это ID группы (отрицательное число)

## Запуск

### Режим разработки (с автоперезагрузкой):
```bash
npm run dev
```

### Продакшн:
```bash
npm start
```

## API Endpoints

### POST /api/chat/send
Отправляет сообщение от пользователя в Telegram группу.

**Body:**
```json
{
  "userId": "user_123",
  "message": "Привет!",
  "timestamp": 1234567890
}
```

### GET /api/chat/messages?userId=user_123
Получает все сообщения для пользователя.

**Response:**
```json
{
  "success": true,
  "messages": [
    {
      "text": "Привет!",
      "isOutgoing": true,
      "timestamp": 1234567890,
      "userId": "user_123"
    }
  ]
}
```

### GET /health
Проверка состояния сервера.

## Как это работает

1. Пользователь отправляет сообщение через веб-интерфейс
2. Сообщение сохраняется на сервере и отправляется в Telegram группу
3. Менеджер отвечает на сообщение в Telegram (reply)
4. Сервер отслеживает ответы и связывает их с пользователем
5. Пользователь получает ответ через API

## Важно

- В продакшене используйте базу данных вместо Map для хранения сообщений
- Настройте CORS для вашего домена
- Используйте HTTPS в продакшене
- Храните токены в безопасном месте

